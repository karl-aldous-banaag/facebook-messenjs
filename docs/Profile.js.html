<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Profile.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Profile.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const fetch = require('make-fetch-happen');
const Client = require('./client/Client');
const BaseQuickReply = require('./message/quickReplies/BaseQuickReply');
const Buttons = require('./buttons/Buttons');
const BaseTemplate = require('./message/template/BaseTemplate');

class Profile {
    /**
     * @param {Client} client
     * @param {String} id - ID of Profile
     * @property {Client} client
     * @property {String} id
     */
    constructor(client, id) {
        this.client = client;
        this.id = id;

        this.client.profileManager.cache.set(id, this);
    }

    /**
     * @property {Function} deletePersistentMenu
     * @returns {null}
     */
    deletePersistentMenu() {
        fetch(`https://graph.facebook.com/v17.0/me/custom_user_settings?psid=${this.id}&amp;params=[%22persistent_menu%22]&amp;access_token=${this.client.pageToken}`, {
            method: 'delete'
        });
    }

    /**
     * @property {Function} getJSON - gets JSON object with data about a user
     * @returns {Object}
     */
    getJSON() {
        return {
            id: this.id
        }
    }

    /**
     * @property {Function} getPersistentMenu - gets data about persistent menu shown to a user
     * @returns {Promise}
     */
    getPersistentMenu() {
        if (!this.id) { throw "user ID missing for getting the persistent menu of a user"; }
        if (!this.client.pageToken) { throw "token missing for client" }

        return new Promise((resolve, reject) => {
            fetch(`https://graph.facebook.com/v17.0/me/custom_user_settings?psid=${this.id}&amp;access_token=${this.client.pageToken}`)
                .then(res => res.json())
                .then(json => {
                    if (!("data" in json)) { reject(json) }
                    if (!("user_level_persistent_menu" in json.data[0])) { reject(json) }
                    if (!("call_to_actions" in json.data[0].user_level_persistent_menu[0])) { reject(json) }

                    let callToActions = json.data[0].user_level_persistent_menu[0].call_to_actions;
                    let buttons = [];
                    for (let i = 0; i &lt; callToActions.length; i++) {
                        if (callToActions[i].type === "postback") {
                            buttons.push(new Buttons.PostbackButton(
                                callToActions[i].title,
                                callToActions[i].payload
                            ));
                        } else if (callToActions[i].type === "web_url") {
                            buttons.push(new Buttons.URLButton(
                                callToActions[i].title,
                                callToActions[i].url,
                                callToActions[i].webview_height_ratio
                            ));
                        }
                    }

                    resolve(buttons);
                });
        });
    }

    /**
     * @property {Function} getPersonalInfo
     * @param {Array.&lt;String>} [fields] fields of desired personal information
     * @returns {Promise}
     */
    getPersonalInfo(fields = ["first_name", "last_name", "profile_pic"]) {
        if ((this.firstName) &amp;&amp; (this.lastName) &amp;&amp; (this.profilePic)) {
            return new Promise((resolve, reject) => { resolve(this); });
        }

        let fieldCopy = [...fields];

        if (("first_name" in fieldCopy) &amp;&amp; (this.firstName)) fieldCopy.splice(fieldCopy.indexOf("first_name"), 1);
        if (("last_name" in fieldCopy) &amp;&amp; (this.lastName)) fieldCopy.splice(fieldCopy.indexOf("last_name"), 1);
        if (("profile_pic" in fieldCopy) &amp;&amp; (this.profilePic)) fieldCopy.splice(fieldCopy.indexOf("last_name"), 1);

        if (fieldCopy.length > 0) {
            let fieldParam = fieldCopy.join(',');

            return fetch(`https://graph.facebook.com/${this.id}?fields=${fieldParam}&amp;access_token=${this.client.pageToken}`)
                .then(res => res.json())
                .then(json => {
                    this.firstName = json.first_name;
                    this.lastName = json.last_name;
                    this.profilePic = json.profile_pic;
                    return this
                })
        }

        return new Promise((resolve, reject) => { resolve(this); });
    }

    /**
     * @property {Function} send
     * @param {(String|BaseTemplate)} options
     * @param {Array.&lt;BaseQuickReply>} quickReplies
     * @returns {Promise}
     */
    send(options, quickReplies = []) {
        return new Promise((resolve, reject) => {    
            let replyMsgJSON = {
                sender: { id: this.client.appID },
                recipient:{ id: this.id },
                timestamp: new Date().getTime(),
                message: {
                    text: options
                }
            }

            if (typeof options === "string") {
                replyMsgJSON.message.text = options;
            } else if (options instanceof BaseTemplate) {
                replyMsgJSON.message = {
                    attachment: {
                        type: "template",
                        payload: options.payload
                    }
                }
            }
            
            if (quickReplies.length > 0) {
                let qrs = quickReplies.filter(qr => qr instanceof BaseQuickReply);
                replyMsgJSON.message.quick_replies = qrs.map(qr => qr.getJSON());
            }

            fetch(`https://graph.facebook.com/v17.0/me/messages?access_token=${this.client.pageToken}`, {
                method: 'post',
                body: JSON.stringify(replyMsgJSON),
                headers: { 'Content-Type': 'application/json' }
            })
                .then(res => res.json())
                .then(json => {
                    replyMsgJSON.message.mid = json.message_id;
                    let cachedMessage = this.client.messageManager.fetch(replyMsgJSON);
                    resolve(cachedMessage);
                });
        })
    }

    /**
     * @property {Function} setPersistentMenu
     * @param {Array.&lt;Buttons.BaseButton>} buttons
     * @returns {Promise}
     */
    setPersistentMenu(buttons) {
        return new Promise((resolve, reject) => {
            let postObject = {
                psid: this.id,
                persistent_menu: [
                    {
                        locale: "default",
                        composer_input_disabled: false,
                        call_to_actions: buttons.map(button => button.json)
                    }
                ]
            }
    
            fetch(`https://graph.facebook.com/v17.0/me/custom_user_settings?access_token=${this.client.pageToken}`, {
                method: 'post',
                body: JSON.stringify(postObject),
                headers: { 'Content-Type': 'application/json' }
            })
                .then(res => resolve(buttons.map(button => button.json)));
        })
    }
}

module.exports = Profile;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseAPI.html">BaseAPI</a></li><li><a href="BaseAttachment.html">BaseAttachment</a></li><li><a href="BaseButton.html">BaseButton</a></li><li><a href="BaseEvent.html">BaseEvent</a></li><li><a href="BaseQuickReply.html">BaseQuickReply</a></li><li><a href="BaseTemplate.html">BaseTemplate</a></li><li><a href="CallButton.html">CallButton</a></li><li><a href="Client.html">Client</a></li><li><a href="Collection.html">Collection</a></li><li><a href="DeliveryEvent.html">DeliveryEvent</a></li><li><a href="GenericTemplate.html">GenericTemplate</a></li><li><a href="Message.html">Message</a></li><li><a href="MessageManager.html">MessageManager</a></li><li><a href="PostbackButton.html">PostbackButton</a></li><li><a href="PostbackEvent.html">PostbackEvent</a></li><li><a href="Profile.html">Profile</a></li><li><a href="ProfileManager.html">ProfileManager</a></li><li><a href="ReactionEvent.html">ReactionEvent</a></li><li><a href="ReadEvent.html">ReadEvent</a></li><li><a href="TextQuickReply.html">TextQuickReply</a></li><li><a href="URLButton.html">URLButton</a></li></ul><h3>Events</h3><ul><li><a href="Client.html#event:accountLinking">accountLinking</a></li><li><a href="Client.html#event:messageDelivery">messageDelivery</a></li><li><a href="Client.html#event:messageReaction">messageReaction</a></li><li><a href="Client.html#event:messageRead">messageRead</a></li><li><a href="Client.html#event:messages">messages</a></li><li><a href="Client.html#event:messagingOptin">messagingOptin</a></li><li><a href="Client.html#event:messagingPostback">messagingPostback</a></li><li><a href="Client.html#event:policyEnforcement">policyEnforcement</a></li><li><a href="Client.html#event:referral">referral</a></li></ul><h3>Global</h3><ul><li><a href="global.html#makeDefault">makeDefault</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Fri Jul 07 2023 08:53:06 GMT+0800 (Philippine Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
